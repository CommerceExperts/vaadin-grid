<!--
@license
Copyright (c) 2018 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<script>
  window.Vaadin = window.Vaadin || {};
  window.Vaadin.Grid = window.Vaadin.Grid || {};

  /**
   * @polymerMixin
   */
  Vaadin.Grid.DetailedEventMixin = superClass => class DetailedEventMixin extends superClass {

    static get properties() {
      return {
        /**
         * Array of events, which will be fired with additional information about the event target:
         * - `rowData`: contains eg. `item` and `index`
         * - `column`: the column element corresponding to the clicked cell
         * - `section`: whether the event targeted the body, header, footer or details of the grid
         * - `originalEvent`: the native event which triggered the detailed event
         *
         * The detailed event will have `detailed-` prefix. For example, after adding `click`
         * to `detailedEvents`, you should listen for `detailed-click` events.
         */
        detailedEvents: {
          type: Array
        },

        _detailedEventListeners: {
          type: Object,
          value: () => {
            return {};
          }
        }
      };
    }

    static get observers() {
      return ['_detailedEventsChanged(detailedEvents, detailedEvents.splices)'];
    }

    _detailedEventsChanged(newEvents) {
      const oldEvents = Object.keys(this._detailedEventListeners);

      if (newEvents) {
        newEvents.filter(event => !(oldEvents && oldEvents.indexOf(event) > -1))
          .forEach(this._addDetailedEventListener, this);
      }

      if (oldEvents) {
        oldEvents.filter(event => !(newEvents && newEvents.indexOf(event) > -1))
          .forEach(this._removeDetailedEventListener, this);
      }
    }

    _addDetailedEventListener(eventName) {
      const listener = e => {

        const path = e.composedPath();
        const cell = path[path.indexOf(this.$.table) - 3];

        if (!cell) {
          return;
        }

        const section = ['body', 'header', 'footer', 'details']
          .filter(section => cell.getAttribute('part').indexOf(section) > -1)[0];

        const detail = {
          rowData: section === 'body' || section === 'details' ?
            this.__getRowModel(cell.parentElement) : undefined,
          column: cell._column,
          section: section,
          originalEvent: e
        };

        this.dispatchEvent(new CustomEvent('detailed-' + eventName, {detail: detail}));
      };

      this.addEventListener(eventName, listener);
      this._detailedEventListeners[eventName] = listener;
    }

    _removeDetailedEventListener(eventName) {
      this.removeEventListener(eventName, this._detailedEventListeners[eventName]);
      delete this._detailedEventListeners[eventName];
    }

  };
</script>