<!doctype html>

<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../iron-test-helpers/mock-interactions.js"></script>
  <link rel="import" href="../../test-fixture/test-fixture.html">

  <link rel="import" href="helpers.html">
  <link rel="import" href="../all-imports.html">
</head>

<body>

  <test-fixture id="grid">
    <template>
      <vaadin-grid items='[{"foo": "bar"}]'>
        <vaadin-grid-column-group header="column group header">
          <template class="footer">
            column group footer
          </template>
          <vaadin-grid-column path="foo" header="column header">
            <template class="footer">
              column footer
            </template>
          </vaadin-grid-column>
        </vaadin-grid-column-group>
      </vaadin-grid>
    </template>
  </test-fixture>

  <script>
    describe('detailed events', () => {
      let grid, column, columnGroup,
        clickSpy,
        cells;

      beforeEach(() => {
        grid = fixture('grid');
        column = grid.querySelector('vaadin-grid-column');
        columnGroup = grid.querySelector('vaadin-grid-column-group');

        grid.rowDetailsRenderer = function(root, grid, rowData) {
          root.innerHTML = '<div>details</div>';
        };
        grid.openItemDetails(grid.items[0]);

        clickSpy = sinon.spy();

        grid.detailedEvents = ['click'];
        grid.addEventListener('detailed-click', clickSpy);

        flushGrid(grid);
        cells = {
          // From top to bottom:
          groupheader: getContainerCell(grid.$.header, 0, 0),
          header: getContainerCell(grid.$.header, 1, 0),
          body: getContainerCell(grid.$.items, 0, 0),
          details: getContainerCell(grid.$.items, 0, 1),
          footer: getContainerCell(grid.$.footer, 0, 0),
          groupfooter: getContainerCell(grid.$.footer, 1, 0),
        };
      });

      it('should dispatch detailed event', () => {
        click(cells.body);
        expect(clickSpy).to.be.calledOnce;
      });

      it('should not dispatch detailed event when targeting empty body', () => {
        click(grid.$.table);
        expect(clickSpy).to.not.be.called;
      });

      describe('event includes details', () => {
        ['body', 'header', 'footer', 'details', 'groupheader', 'groupfooter'].forEach(cellName => {
          it(`should include details for ${cellName} cell`, function(done) {
            grid.addEventListener('detailed-click', e => {

              if (cellName === 'body' || cellName === 'details') {
                expect(e.detail.rowData.item).to.equal(grid.items[0]);
                expect(e.detail.rowData.index).to.equal(0);
              } else {
                expect(e.detail.rowData).to.be.undefined;
              }

              if (cellName === 'details') {
                expect(e.detail.column).to.undefined;
              } else if (cellName.indexOf('group') > -1) {
                expect(e.detail.column).to.equal(columnGroup);
              } else {
                expect(e.detail.column).to.equal(column);
              }

              let expectedSection = cellName;
              if (cellName === 'groupheader') {
                expectedSection = 'header';
              } else if (cellName === 'groupfooter') {
                expectedSection = 'footer';
              }
              expect(e.detail.section).to.equal(expectedSection);

              expect(e.detail.originalEvent.type).to.equal('click');
              done();
            });
            click(cells[cellName]);
          });
        });
      });

      describe('changing the array', () => {

        let fooSpy, barSpy;

        // Verify that after firing the original events, the given spies are
        // invoked exactly once, and other spies are not called at all
        const testSpies = expectedSpies => {
          ['click', 'foo', 'bar'].forEach(eventName =>
            cells.body.dispatchEvent(new CustomEvent(eventName, {bubbles: true, composed: true})));

          expectedSpies.forEach(spy => expect(spy).to.be.calledOnce);
          [clickSpy, fooSpy, barSpy].filter(spy => expectedSpies.indexOf(spy) < 0)
            .forEach(spy => expect(spy).to.not.be.called);
        };

        beforeEach(() => {
          fooSpy = sinon.spy();
          barSpy = sinon.spy();
          grid.addEventListener('detailed-foo', fooSpy);
          grid.addEventListener('detailed-bar', barSpy);
        });

        it('should not fire detailed events after clearing the array', () => {
          grid.detailedEvents = [];
          testSpies([]);
        });

        it('should fire detailed events after changing the array', () => {
          grid.detailedEvents = ['click', 'foo'];
          testSpies([clickSpy, fooSpy]);
        });

        it('should fire detailed events after pushing new value to the array', () => {
          grid.push('detailedEvents', 'foo');
          testSpies([clickSpy, fooSpy]);
        });

        it('should not fire detailed events for an event removed from the array', () => {
          grid.detailedEvents = ['foo', 'bar', 'click'];
          grid.splice('detailedEvents', 0, 1);
          testSpies([clickSpy, barSpy]);
        });

        it('should not fire double events when re-setting the same event', () => {
          grid.detailedEvents = ['click'];
          testSpies([clickSpy]);
        });

        it('should not fire double events when having duplicate event in the array', () => {
          grid.detailedEvents = ['click', 'click'];
          testSpies([clickSpy]);
        });

        it('should not fire detailed events when the array is undefined', () => {
          grid.detailedEvents = undefined;
          testSpies([]);
        });

        it('should not fire detailed events when the array is null', () => {
          grid.detailedEvents = null;
          testSpies([]);
        });

        it('should fire detailed events after changing the array from undefined', () => {
          grid.detailedEvents = undefined;
          grid.detailedEvents = ['foo', 'bar'];
          testSpies([fooSpy, barSpy]);
        });

      });

    });
  </script>

</body>

</html>